name: Automated Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci

    - name: Run validation scripts
      run: |
        echo "üîç Running validation scripts..."
        if [ -f "scripts/validate-agents.sh" ]; then
          chmod +x scripts/validate-agents.sh
          ./scripts/validate-agents.sh
        else
          echo "‚ö†Ô∏è validate-agents.sh not found, creating basic validation..."
          # Valida√ß√£o b√°sica de agentes
          echo "üìä Validating agent structure..."
          if [ -d ".claude/agents" ]; then
            echo "‚úÖ Agents directory exists"
            AGENT_COUNT=$(find .claude/agents -name "*.md" | wc -l)
            echo "üìà Agent count: $AGENT_COUNT"
          else
            echo "‚ùå Agents directory not found"
          fi
        fi

        if [ -f "scripts/system-check.sh" ]; then
          chmod +x scripts/system-check.sh
          ./scripts/system-check.sh
        else
          echo "‚ö†Ô∏è system-check.sh not found, running basic system check..."
          # Verifica√ß√£o b√°sica do sistema
          echo "üîß Checking system configuration..."
          if [ -f "CLAUDE.md" ]; then
            echo "‚úÖ CLAUDE.md found"
          fi
          if [ -f ".claude.json" ]; then
            echo "‚úÖ .claude.json found"
          fi
          if [ -f ".mcp.json" ]; then
            echo "‚úÖ .mcp.json found"
          fi
        fi

    - name: Run security audit
      run: |
        npm audit --audit-level moderate

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-results/
          coverage/

  quality:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Code quality check
      run: |
        echo "üîç Running code quality checks..."
        # Adicionar ESLint, Prettier, etc.
        echo "‚úÖ Quality checks completed"

    - name: Performance test
      run: |
        echo "‚ö° Running performance tests..."
        # Adicionar testes de performance
        echo "‚úÖ Performance tests completed"