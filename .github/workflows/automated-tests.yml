name: Automated Static Site Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run validation scripts
      run: |
        echo "üîç Running validation scripts..."
        if [ -f "scripts/validate-agents.sh" ]; then
          chmod +x scripts/validate-agents.sh
          ./scripts/validate-agents.sh
        else
          echo "‚ö†Ô∏è validate-agents.sh not found, creating basic validation..."
          # Valida√ß√£o b√°sica de agentes
          echo "üìä Validating agent structure..."
          if [ -d ".claude/agents" ]; then
            echo "‚úÖ Agents directory exists"
            AGENT_COUNT=$(find .claude/agents -name "*.md" | wc -l)
            echo "üìà Agent count: $AGENT_COUNT"
          else
            echo "‚ùå Agents directory not found"
          fi
        fi

        if [ -f "scripts/system-check.sh" ]; then
          chmod +x scripts/system-check.sh
          ./scripts/system-check.sh
        else
          echo "‚ö†Ô∏è system-check.sh not found, running basic system check..."
          # Verifica√ß√£o b√°sica do sistema
          echo "üîß Checking system configuration..."
          if [ -f "CLAUDE.md" ]; then
            echo "‚úÖ CLAUDE.md found"
          fi
          if [ -f ".claude/agents" ]; then
            echo "‚úÖ .claude/agents directory found"
          fi
        fi

    - name: Run security audit
      run: |
        echo "üîí Running security checks for static site..."

        # Check for exposed secrets or sensitive data
        echo "Checking for potential secrets..."
        if grep -r -i "password\|secret\|key\|token\|api" --include="*.html" --include="*.js" . | grep -v ".git" | head -10; then
          echo "‚ö†Ô∏è Found potential sensitive information (review manually)"
        else
          echo "‚úÖ No obvious secrets found"
        fi

        # Check for external scripts from unknown domains
        echo "Checking external scripts..."
        find . -name "*.html" -exec grep -o 'src="[^"]*"' {} \; | grep "^src=\"http" | head -5

        # Check for inline event handlers (security concern)
        echo "Checking for inline event handlers..."
        find . -name "*.html" -exec grep -l "onclick\|onload\|onerror" {} \; | head -5
        echo "‚úÖ Security checks completed"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-results
        path: |
          validation-results/
          logs/

  quality:
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Code quality check
      run: |
        echo "üîç Running code quality checks..."

        # Validate HTML structure
        echo "Validating HTML files..."
        find . -name "*.html" | while read file; do
          echo "Checking $file"
          # Basic HTML validation
          xmllint --noout --html "$file" 2>/dev/null || {
            echo "‚ö†Ô∏è HTML validation issues in $file (may be HTML5 specific)"
          }
        done

        # Check CSS syntax
        echo "Validating CSS files..."
        if command -v csslint >/dev/null 2>&1; then
          find . -name "*.css" -exec csslint {} \; || echo "‚ö†Ô∏è CSS linting warnings found"
        else
          echo "‚ö†Ô∏è csslint not available"
        fi

        echo "‚úÖ Quality checks completed"

    - name: Performance test
      run: |
        echo "‚ö° Running performance tests..."

        # Check file sizes
        echo "Checking file sizes..."
        find . -name "*.html" -exec ls -lh {} \; | awk '$5 > "500k" {print "‚ö†Ô∏è Large HTML file: " $9 " (" $5 ")"}'
        find . -name "*.css" -exec ls -lh {} \; | awk '$5 > "100k" {print "‚ö†Ô∏è Large CSS file: " $9 " (" $5 ")"}'

        # Check for optimization opportunities
        echo "Checking optimization opportunities..."
        find . -name "*.html" -exec grep -l "style=" {} \; | head -3
        find . -name "*.html" -exec grep -l "<script>" {} \; | head -3

        echo "‚úÖ Performance tests completed"