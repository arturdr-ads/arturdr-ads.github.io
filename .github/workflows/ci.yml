name: Static Site CI/CD Pipeline

"on":
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Sets permissions for the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and validation job
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    # Static site validation
    - name: Validate HTML
      run: |
        echo "üîç Validating HTML files..."
        find . -name "*.html" -not -path "./_site/*" | while read file; do
          echo "Validating $file"
          # Basic HTML validation using xmllint
          xmllint --noout --html "$file" 2>/dev/null || {
            echo "‚ùå HTML validation failed for $file"
            echo "‚ö†Ô∏è Continuing as HTML5 may have valid errors in xmllint"
          }
        done
        echo "‚úÖ HTML validation completed"

    - name: Validate CSS
      run: |
        echo "üé® Validating CSS files..."
        # Check for CSS syntax errors
        find . -name "*.css" -not -path "./_site/*" | while read file; do
          echo "Validating $file"
          # Basic CSS validation
          if command -v csslint >/dev/null 2>&1; then
            csslint "$file" || echo "‚ö†Ô∏è CSS linting warnings found"
          else
            echo "‚ö†Ô∏è csslint not available, skipping detailed CSS validation"
          fi
        done
        echo "‚úÖ CSS validation completed"

    - name: Check file sizes
      run: |
        echo "üìä Checking file sizes..."
        # Check for oversized files
        find . -type f -name "*.html" -not -path "./_site/*" -exec ls -lh {} \; | awk '$5 > "500k" {print "‚ö†Ô∏è Large HTML file: " $9 " (" $5 ")"}'
        find . -type f -name "*.css" -not -path "./_site/*" -exec ls -lh {} \; | awk '$5 > "100k" {print "‚ö†Ô∏è Large CSS file: " $9 " (" $5 ")"}'
        find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \) -not -path "./_site/*" -exec ls -lh {} \; | awk '$5 > "1M" {print "‚ö†Ô∏è Large image file: " $9 " (" $5 ")"}'
        echo "‚úÖ File size check completed"

    - name: Check for broken internal links
      run: |
        echo "üîó Checking internal links..."
        # Extract HTML files and check internal links
        find . -name "*.html" -not -path "./_site/*" | while read file; do
          # Check for local .html links that point to non-existent files
          grep -o 'href="[^"]*\.html"' "$file" | sed 's/href="//' | sed 's/"//' | while read link; do
            if [[ "$link" != http* ]] && [[ "$link" != //* ]]; then
              target_path="$(dirname "$file")/$link"
              if [[ ! -f "$target_path" ]]; then
                echo "‚ö†Ô∏è Broken link in $file: $link -> $target_path"
              fi
            fi
          done
        done
        echo "‚úÖ Link check completed"

    - name: SEO and accessibility check
      run: |
        echo "üîç SEO and accessibility checks..."
        # Check for essential meta tags in index.html
        if [ -f "index.html" ]; then
          echo "Checking index.html for SEO essentials..."
          if ! grep -q "<meta.*charset.*UTF-8" index.html; then
            echo "‚ö†Ô∏è Missing charset meta tag"
          fi
          if ! grep -q "<meta.*viewport.*width=device-width" index.html; then
            echo "‚ö†Ô∏è Missing viewport meta tag"
          fi
          if ! grep -q "<meta.*name=\"description\"" index.html; then
            echo "‚ö†Ô∏è Missing description meta tag"
          fi
          if ! grep -q "<title>" index.html; then
            echo "‚ö†Ô∏è Missing title tag"
          fi
        fi
        echo "‚úÖ SEO checks completed"

    - name: Performance audit (Lighthouse)
      run: |
        echo "‚ö° Running basic performance checks..."
        # Check for common performance issues
        echo "Checking for inline CSS/JS that could be externalized..."
        find . -name "*.html" -not -path "./_site/*" -exec grep -l "style=" {} \; | head -5
        find . -name "*.html" -not -path "./_site/*" -exec grep -l "<script>" {} \; | head -5
        echo "‚úÖ Performance checks completed"

  # Security validation job
  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Security scan
      run: |
        echo "üîí Running security checks..."

        # Check for exposed secrets or sensitive data
        echo "Checking for potential secrets..."
        if grep -r -i "password\|secret\|key\|token\|api" --include="*.html" --include="*.js" . | grep -v ".git" | head -10; then
          echo "‚ö†Ô∏è Found potential sensitive information (review manually)"
        else
          echo "‚úÖ No obvious secrets found"
        fi

        # Check for external scripts from unknown domains
        echo "Checking external scripts..."
        find . -name "*.html" -not -path "./_site/*" -exec grep -o 'src="[^"]*"' {} \; | grep "^src=\"http" | head -5

        # Check for inline event handlers (security concern)
        echo "Checking for inline event handlers..."
        find . -name "*.html" -not -path "./_site/*" -exec grep -l "onclick\|onload\|onerror" {} \; | head -5
        echo "‚úÖ Security checks completed"

  # Deploy to GitHub Pages (only on main branch)
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Build for Pages
      run: |
        echo "üöÄ Building static site for GitHub Pages..."

        # Create build directory
        mkdir -p _site

        # Copy all static files to _site
        cp -r assets _site/ 2>/dev/null || echo "No assets directory found"
        cp -r docs _site/ 2>/dev/null || echo "No docs directory found"
        cp -r scripts _site/ 2>/dev/null || echo "No scripts directory found"
        cp *.html _site/ 2>/dev/null || echo "No HTML files found"
        cp *.css _site/ 2>/dev/null || echo "No CSS files found"
        cp *.js _site/ 2>/dev/null || echo "No JS files found"
        cp *.png *.jpg *.jpeg *.gif *.svg *.ico _site/ 2>/dev/null || echo "No image files found"
        cp *.json *.xml *.txt *.md _site/ 2>/dev/null || echo "No other files found"

        # Generate a simple sitemap using echo
        echo '<?xml version="1.0" encoding="UTF-8"?>' > _site/sitemap.xml
        echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> _site/sitemap.xml
        echo '    <url>' >> _site/sitemap.xml
        echo '        <loc>https://arturdr-ads.github.io/</loc>' >> _site/sitemap.xml
        echo "        <lastmod>${{ github.event.head_commit.timestamp }}</lastmod>" >> _site/sitemap.xml
        echo '        <changefreq>weekly</changefreq>' >> _site/sitemap.xml
        echo '        <priority>1.0</priority>' >> _site/sitemap.xml
        echo '    </url>' >> _site/sitemap.xml
        echo '</urlset>' >> _site/sitemap.xml

        # List contents for verification
        echo "üìÅ Site contents:"
        ls -la _site/
        echo "‚úÖ Build completed"

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4